# 新东方首页改版方案（前端）

**我们的网站：**

首页文件总大小：6.4M+(其中图片资源6.2M，js文件212.4K，css文件15.8K)

400+个请求，DOMContentloaded 6s+, FInish 60s+

网站加载完成需要时间：60S+

**其他的网站：**

DOMContentloaded `5s`以内，甚至是毫秒级别的，Finish `10S`左右， 首屏展现非常快。

## 改版目的

提高页面加载速度，提高首屏展现速度，提升用户体验

## 优化方案

1. 页面中图片尺寸、大小限制、设置一个图片大小上限，大图建议走特殊流程。目前压缩图片可将其大小减少1.1 MiB (22%)。图片格式的选用 http://www.cnblogs.com/wizcabbit/p/web-image-optimization.html
2. 图片服务使用cdn，且使用多个域名，提高并行下载速度；图片延迟加载按需加载，优先加载文本展示和样式展示。 图片给定宽度和或高度属性，减少页面回流。
3. 首屏优化，第一屏的内容直接输出到浏览器，后面的模块延时加载、按需加载、滚动加载
4. tab标签中的内容显示时才加载（或者中的内容全部加载出来，但是图片在被显示的时候才去请求）
5. 后移统计代码的加载位置，优先加载页面必须资源
6. js css 压缩处理,js css 加载顺序处理
7. 减少重定向
8. 启用gzip 启用浏览器缓存
9. 避免404
10. 代码性能优化--

## 预期优化结果

- 图片优化后首次加载图片大小约为600K（首屏图片极限大小`465K`+100K左右的css用图片）
- 减少页面请求个数，预计DOMContentloaded时间为5S左右 Finish20S左右 请求数requests 100以内

## 各部门需要确认的问题

- 由于采用首屏优先展示的方案，后面的内容在需要的时候才会请求，SEO优化可能会受到影响
- 异步请求需要php后台的支持
- 图片按需加载，延时加载页需要后端配合
- 图片多个此存，小图显示缩略图，详情页显示大图，图片对应相应缩略图和原图
- 图片尺寸大小需要编辑部门严格遵守（或者通过程序自动化完成，但是有些内容比较丰富的图片清晰度会收到影响）

## 详细方案

### 图片尺寸及大小限制

下面的尺寸是最大值，图片压缩的时候大小当然是越小越好

如按照下面图片大小严格控制，首页的图片资源总大小将低于`2M`

- 首屏轮播图

```
尺寸：720×330
大小：不超过50K
数量：6
极限大小：6×50=300K
```

- 首屏轮播图下卡片广告位

```
尺寸：320×150
大小：照片类不超过15K，非照片类不超过10K
数量：6
极限大小：6×15=90K
```

- 首屏底部4联广告位

```
尺寸：220×255
大小：照片类不超过15K
数量：4
极限大小：5×15=75K
```

- 课程列表

```
尺寸：220×140
大小：照片类不超过12K
数量：4×33(tab) = 132
极限大小：132×12=1584K
```

### 图片服务使用cdn

目前首页图片主要存放于`file.koolearn.com`和`img.koolearn.com`

其中`file.koolearn.com`的缓存策略为图片缓存1天

- 增加图片缓存的时间
- 增加镜像服务器`file1.***;file2.***;file3.***等`

### 首屏优化

减少代码请求，提升用户体验

- 首屏代码直接输出到浏览器
- 后续代码分块（如按照已有的块：出国留学，研究生，大学等）在用户浏览到该块内容时再进行异步请求，加载内容

### tab标签优化

用户看不到的内容暂时不加载，提高可见内容的加载速度

### 统计代码后置

优先加载页面必须资源（js，css）尽快展示首屏内容


###20150806上线第一版优化结过

除首屏外的其他模块全部做延时加载或者滚动加载、按需加载但是他们考虑到seo，以及站点排名就放弃，本想单独做一个seo的页面，但是也被否了。所以我们唯一能做的就是调整首页里面的资源加载顺序，以及图片按需加载。

以下结果来源于公司电脑的测试：

- 网站首屏加载大小减少60%     `6.4M --> 2.1M`
- request减少百分之68%   `400+ --> 163`
- load 完成时间减少80%     `60S+ --> 13S`
- 首屏展现更快

###后续优化

压缩广告位图片的大小，对首屏轮播图做延时加载，保证其他的能第一时间展现在用户面前，较少右侧区域白屏时间
